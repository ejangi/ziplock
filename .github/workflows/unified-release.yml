name: Unified Release Build

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]
    paths:
      - "shared/**"
      - "desktop/**"
      - "mobile/**"
      - "scripts/build/**"
      - ".github/docker/**"
      - ".github/workflows/unified-release.yml"
      - "Cargo.toml"
      - "Cargo.lock"
  workflow_dispatch:

permissions:
  contents: write
  packages: write

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Test and build all components once
  test-and-build:
    name: Test and Build All Platforms
    runs-on: ubuntu-22.04
    outputs:
      version: ${{ steps.version.outputs.VERSION }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy
        continue-on-error: true
        id: rust-install

      - name: Manual Rust installation (fallback)
        if: steps.rust-install.outcome == 'failure'
        run: |
          curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
            --default-toolchain stable \
            --component rustfmt,clippy
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          source $HOME/.cargo/env

      - name: Setup Rust environment
        run: |
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH
          rustc --version
          cargo --version

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-unified-cargo-${{ hashFiles('**/Cargo.lock') }}-${{ hashFiles('**/*.rs') }}
          restore-keys: |
            ${{ runner.os }}-unified-cargo-${{ hashFiles('**/Cargo.lock') }}-
            ${{ runner.os }}-unified-cargo-

      - name: Install Linux dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxft-dev \
            liblzma-dev \
            libgtk-4-dev \
            libadwaita-1-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libgtk-3-dev \
            libgdk-pixbuf-2.0-dev \
            libglib2.0-dev \
            libcairo2-dev \
            libpango1.0-dev

      - name: Verify GTK4 installation
        run: |
          pkg-config --exists gtk4 || {
            echo "GTK4 not found, attempting alternative installation"
            exit 1
          }
          pkg-config --modversion gtk4

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: |
          # Run clippy on shared library
          cargo clippy -p ziplock-shared --all-targets -- \
            -D warnings -A clippy::uninlined-format-args -A unused-imports -A dead-code -A clippy::not-unsafe-ptr-arg-deref -A clippy::should-implement-trait -A unused-unsafe -A clippy::collapsible-str-replace -A clippy::new-without-default -A clippy::let-and-return -A clippy::needless-borrows-for-generic-args -A clippy::needless-range-loop -A clippy::unnecessary-map-or -A clippy::collapsible-if -A clippy::needless-late-init -A clippy::unnecessary-cast -A clippy::needless-borrow -A clippy::field-reassign-with-default -A clippy::overly-complex-bool-expr -A clippy::for-kv-map -A unused-variables -A unused-must-use -A clippy::useless-format -A clippy::items-after-test-module

          # Run clippy on unified application (iced-gui features only)
          cargo clippy -p ziplock-linux --no-default-features --features "iced-gui,wayland-support,file-dialog" --all-targets -- \
            -D warnings -A clippy::uninlined-format-args -A unused-imports -A dead-code -A clippy::not-unsafe-ptr-arg-deref -A clippy::should-implement-trait -A unused-unsafe -A clippy::collapsible-str-replace -A clippy::new-without-default -A clippy::let-and-return -A clippy::needless-borrows-for-generic-args -A clippy::needless-range-loop -A clippy::unnecessary-map-or -A clippy::collapsible-if -A clippy::needless-late-init -A clippy::unnecessary-cast -A clippy::needless-borrow -A clippy::field-reassign-with-default -A clippy::overly-complex-bool-expr -A clippy::for-kv-map -A unused-variables -A unused-must-use -A clippy::useless-format -A clippy::items-after-test-module

      - name: Run tests
        run: |
          cargo test --workspace --all-features

      - name: Build Linux binaries
        run: |
          # Build the ziplock binary from the Linux app workspace member
          cargo build --release --bin ziplock -p ziplock-linux

          # Create output directory structure
          mkdir -p target/artifacts/linux/binaries
          cp target/release/ziplock target/artifacts/linux/binaries/

          # Make binaries executable
          chmod +x target/artifacts/linux/binaries/*

      - name: Extract version
        id: version
        run: |
          VERSION=$(grep '^version' Cargo.toml | head -1 | sed -n 's/.*"\(.*\)".*/\1/p')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Upload Linux build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-binaries
          path: target/artifacts/linux/
          retention-days: 30

  # Security audit
  security-audit:
    name: Security Audit
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-${{ runner.os }}

      - name: Install cargo-audit
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi

      - name: Run security audit
        run: cargo audit

  # Build Android libraries
  build-android:
    name: Build Android Libraries
    runs-on: ubuntu-latest
    container: ghcr.io/ejangi/ziplock/android-builder:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust toolchain and Android environment
        run: |
          rustup default stable
          rustup update

          # Install Android targets
          rustup target add aarch64-linux-android
          rustup target add armv7-linux-androideabi
          rustup target add x86_64-linux-android
          rustup target add i686-linux-android

          # Note: Using direct cargo build instead of cargo-ndk to handle cdylib issues

          # Verify Android NDK is available
          if [ -n "$ANDROID_NDK_HOME" ]; then
            echo "Android NDK found at: $ANDROID_NDK_HOME"
            export NDK_HOME="$ANDROID_NDK_HOME"
          elif [ -n "$NDK_HOME" ]; then
            export ANDROID_NDK_HOME="$NDK_HOME"
            echo "Android NDK found at: $ANDROID_NDK_HOME"
          else
            echo "Warning: Android NDK environment variables not set"
            # Try to find NDK in common locations
            for ndk_path in /opt/android-ndk* /usr/local/lib/android/sdk/ndk/*; do
              if [ -d "$ndk_path" ]; then
                export ANDROID_NDK_HOME="$ndk_path"
                export NDK_HOME="$ndk_path"
                echo "Found NDK at: $ANDROID_NDK_HOME"
                break
              fi
            done
          fi

          # Verify NDK tools are available
          if [ -n "$ANDROID_NDK_HOME" ]; then
            echo "Verifying NDK tools..."
            ls -la "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/" | head -5

            # Test cross-compilation tools
            if [ -f "$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang" ]; then
              echo "âœ“ Android cross-compilation tools found"
            else
              echo "âœ— Android cross-compilation tools not found"
            fi
          fi

      - name: Build Android libraries
        shell: bash
        run: |
          cd shared

          # Debug: Check what targets are available
          echo "=== Available Rust targets ==="
          rustup target list --installed | grep android

          # Debug: Check NDK setup
          echo "=== NDK Configuration ==="
          echo "ANDROID_NDK_HOME: $ANDROID_NDK_HOME"
          echo "NDK_HOME: $NDK_HOME"

          # Set up environment for direct cargo build
          export CC_aarch64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/aarch64-linux-android21-clang"
          export CC_armv7_linux_androideabi="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/armv7a-linux-androideabi21-clang"
          export CC_x86_64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/x86_64-linux-android21-clang"
          export CC_i686_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/i686-linux-android21-clang"

          export AR_aarch64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export AR_armv7_linux_androideabi="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export AR_x86_64_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"
          export AR_i686_linux_android="$ANDROID_NDK_HOME/toolchains/llvm/prebuilt/linux-x86_64/bin/llvm-ar"

          # Build for each target with proper environment
          echo "=== Building for Android targets ==="

          targets=("aarch64-linux-android" "armv7-linux-androideabi" "x86_64-linux-android" "i686-linux-android")

          for target in "${targets[@]}"; do
            echo "Building for $target..."
            RUSTFLAGS="-C link-arg=-static-libgcc -C link-arg=-Wl,--as-needed" \
              cargo build --release --target $target --lib --features c-api

            # Check what was built
            echo "Checking build output for $target:"
            if ls "/workspace/target/$target/release/"*ziplock* 1> /dev/null 2>&1; then
              echo "âœ“ Build artifacts found for $target"
            else
              echo "âš  No build artifacts found for $target"
            fi
          done

          # Create output structure
          mkdir -p ../target/android/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}

          # Copy built libraries with fallback handling
          echo "=== Copying libraries ==="

          # Helper function to find and copy library
          copy_library() {
            local target=$1
            local arch_dir=$2
            local cc_var=$3

            # Check both possible paths
            local lib_path=""
            if [ -f "../target/$target/release/libziplock_shared.so" ]; then
              lib_path="../target/$target/release/libziplock_shared.so"
            elif [ -f "/workspace/target/$target/release/libziplock_shared.so" ]; then
              lib_path="/workspace/target/$target/release/libziplock_shared.so"
            fi

            if [ -n "$lib_path" ]; then
              cp "$lib_path" "../target/android/jniLibs/$arch_dir/"
              echo "âœ“ Copied $target library from $lib_path"
              return 0
            fi

            # Try static library fallback
            local static_path=""
            if [ -f "../target/$target/release/libziplock_shared.a" ]; then
              static_path="../target/$target/release/libziplock_shared.a"
            elif [ -f "/workspace/target/$target/release/libziplock_shared.a" ]; then
              static_path="/workspace/target/$target/release/libziplock_shared.a"
            fi

            if [ -n "$static_path" ]; then
              echo "âš  $target cdylib was dropped, using rlib approach"
              eval \$$cc_var -shared -o "../target/android/jniLibs/$arch_dir/libziplock_shared.so" \
                -Wl,--whole-archive "$static_path" -Wl,--no-whole-archive
              echo "âœ“ Created $target shared library from static library"
              return 0
            fi

            echo "âœ— $target library not found in either path"
            return 1
          }

          # Copy libraries for each architecture
          copy_library "aarch64-linux-android" "arm64-v8a" "CC_aarch64_linux_android" || exit 1
          copy_library "armv7-linux-androideabi" "armeabi-v7a" "CC_armv7_linux_androideabi" || exit 1
          copy_library "x86_64-linux-android" "x86_64" "CC_x86_64_linux_android" || exit 1
          copy_library "i686-linux-android" "x86" "CC_i686_linux_android" || exit 1

          # Copy to Android app directory if it exists
          if [ -d "../apps/mobile/android/app/src/main" ]; then
            mkdir -p ../apps/mobile/android/app/src/main/jniLibs/{arm64-v8a,armeabi-v7a,x86_64,x86}
            cp -r ../target/android/jniLibs/* ../apps/mobile/android/app/src/main/jniLibs/
            echo "Libraries copied to Android app jniLibs"
          fi

      - name: Test Android libraries
        shell: bash
        run: |
          echo "Testing Android library outputs..."
          for arch in arm64-v8a armeabi-v7a x86_64 x86; do
            lib_path="target/android/jniLibs/$arch/libziplock_shared.so"
            if [ -f "$lib_path" ]; then
              echo "âœ“ Found library: $arch"
              echo "  Size: $(stat -c%s "$lib_path") bytes"
              echo "  Type: $(file "$lib_path" | cut -d: -f2-)"

              # Check for key symbols
              if readelf -s "$lib_path" | grep -q "ziplock_"; then
                echo "  âœ“ Contains ziplock symbols"
              else
                echo "  âš  No ziplock symbols found"
              fi
            else
              echo "âœ— Missing library: $arch"
            fi
            echo
          done

      - name: Upload Android artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-libraries
          path: target/android/
          retention-days: 30

  # Package for Debian/Ubuntu
  package-debian:
    name: Create Debian Package
    runs-on: ubuntu-22.04
    needs: [test-and-build, security-audit]
    container: ghcr.io/ejangi/ziplock/ubuntu-builder:latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: target/artifacts/linux/

      - name: Create Debian package
        run: |
          # Create package structure
          VERSION="${{ needs.test-and-build.outputs.version }}"
          PKG_DIR="target/debian-package"
          INSTALL_DIR="$PKG_DIR/usr"

          mkdir -p "$INSTALL_DIR/bin"
          mkdir -p "$INSTALL_DIR/share/applications"
          mkdir -p "$INSTALL_DIR/share/icons/hicolor/scalable/apps"
          mkdir -p "$INSTALL_DIR/share/metainfo"
          mkdir -p "$PKG_DIR/DEBIAN"

          # Debug: Check artifact structure
          echo "=== Debugging artifact structure ==="
          echo "Contents of target/artifacts/linux/:"
          ls -la target/artifacts/linux/ || echo "Directory not found"
          echo "Contents of target/artifacts/linux/binaries/:"
          ls -la target/artifacts/linux/binaries/ || echo "Directory not found"
          echo "Finding all files in target/artifacts/:"
          find target/artifacts/ -type f 2>/dev/null || echo "No files found"

          # Copy binaries and make them executable
          if [ -d "target/artifacts/linux/binaries" ]; then
            echo "Copying from binaries directory..."
            cp target/artifacts/linux/binaries/* "$INSTALL_DIR/bin/"
            chmod +x "$INSTALL_DIR/bin/"*
          elif [ -d "target/artifacts/linux" ]; then
            echo "Copying from linux directory..."
            find target/artifacts/linux -type f -exec cp {} "$INSTALL_DIR/bin/" \;
            chmod +x "$INSTALL_DIR/bin/"*
          else
            echo "Error: No artifact directories found"
            exit 1
          fi

          # Verify binaries were copied
          echo "Binaries copied to $INSTALL_DIR/bin/:"
          ls -la "$INSTALL_DIR/bin/"

          # Copy desktop integration files if they exist
          if [ -f "packaging/linux/ziplock.desktop" ]; then
            cp packaging/linux/ziplock.desktop "$INSTALL_DIR/share/applications/"
          fi

          if [ -f "packaging/linux/ziplock.svg" ]; then
            cp packaging/linux/ziplock.svg "$INSTALL_DIR/share/icons/hicolor/scalable/apps/"
          fi

          if [ -f "packaging/linux/ziplock.metainfo.xml" ]; then
            cp packaging/linux/ziplock.metainfo.xml "$INSTALL_DIR/share/metainfo/"
          fi

          # Create control file
          cat > "$PKG_DIR/DEBIAN/control" << EOF
          Package: ziplock
          Version: $VERSION
          Section: utils
          Priority: optional
          Architecture: amd64
          Depends: libgtk-4-1, libadwaita-1-0
          Maintainer: ZipLock Team <contact@ziplock.dev>
          Description: Secure archive manager with modern encryption
           ZipLock is a secure archive manager that provides modern encryption
           for your files and directories. It features a clean GTK4 interface
           and strong cryptographic protection for your data.
          EOF

          # Create postinst script for desktop integration
          cat > "$PKG_DIR/DEBIAN/postinst" << 'EOF'
          #!/bin/bash
          set -e
          if [ "$1" = "configure" ]; then
              # Update desktop database
              if command -v update-desktop-database >/dev/null 2>&1; then
                  update-desktop-database -q /usr/share/applications || true
              fi

              # Update icon cache
              if command -v gtk-update-icon-cache >/dev/null 2>&1; then
                  gtk-update-icon-cache -q /usr/share/icons/hicolor || true
              fi
          fi
          EOF

          chmod 755 "$PKG_DIR/DEBIAN/postinst"

          # Build package
          dpkg-deb --root-owner-group --build "$PKG_DIR" "target/ziplock_${VERSION}_amd64.deb"

      - name: Test package installation
        run: |
          # Install the package
          dpkg -i target/ziplock_*.deb || true
          apt-get update && apt-get install -f -y

          # Verify installation
          which ziplock
          which ziplock-cli
          ziplock --version

      - name: Upload Debian package
        uses: actions/upload-artifact@v4
        with:
          name: debian-package
          path: target/ziplock_*_amd64.deb
          retention-days: 30

  # Package for Arch Linux
  package-arch:
    name: Create Arch Linux Package
    runs-on: ubuntu-22.04
    needs: [test-and-build, security-audit]
    container:
      image: ghcr.io/ejangi/ziplock/arch-builder:latest
      options: --user root

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: target/artifacts/linux/

      - name: Create Arch package
        run: |
          VERSION="${{ needs.test-and-build.outputs.version }}"

          # Create package directory with proper permissions
          mkdir -p /tmp/arch-package
          cd /tmp/arch-package

          # Create source directory structure
          mkdir -p ziplock-src

          # Copy source files (avoiding recursive copy)
          rsync -av --exclude='target/' --exclude='.git/' "$GITHUB_WORKSPACE/" ziplock-src/

          # Create PKGBUILD
          cat > PKGBUILD << EOF
          # Maintainer: ZipLock Team <contact@ziplock.dev>
          pkgname=ziplock
          pkgver=$VERSION
          pkgrel=1
          pkgdesc="Secure archive manager with modern encryption"
          arch=('x86_64')
          url="https://github.com/ejangi/ziplock"
          license=('GPL3')
          depends=('gtk4' 'libadwaita')
          makedepends=('rust' 'cargo' 'pkg-config')
          source=("\$pkgname-\$pkgver.tar.gz::https://github.com/ejangi/ziplock/archive/v\$pkgver.tar.gz")
          sha256sums=('SKIP')

          build() {
              cd "\$pkgname-\$pkgver"
              export CARGO_TARGET_DIR=target
              cargo build --release --locked
          }

          check() {
              cd "\$pkgname-\$pkgver"
              cargo test --release --locked
          }

          package() {
              cd "\$pkgname-\$pkgver"

              # Install binaries (using pre-built artifacts)
              install -Dm755 ../../../target/artifacts/linux/binaries/ziplock "\$pkgdir/usr/bin/ziplock"

              # Install desktop integration files if they exist
              if [ -f packaging/linux/ziplock.desktop ]; then
                  install -Dm644 packaging/linux/ziplock.desktop "\$pkgdir/usr/share/applications/ziplock.desktop"
              fi

              if [ -f packaging/linux/ziplock.svg ]; then
                  install -Dm644 packaging/linux/ziplock.svg "\$pkgdir/usr/share/icons/hicolor/scalable/apps/ziplock.svg"
              fi

              if [ -f packaging/linux/ziplock.metainfo.xml ]; then
                  install -Dm644 packaging/linux/ziplock.metainfo.xml "\$pkgdir/usr/share/metainfo/ziplock.metainfo.xml"
              fi

              # Install documentation
              install -Dm644 README.md "\$pkgdir/usr/share/doc/ziplock/README.md"
              install -Dm644 CHANGELOG.md "\$pkgdir/usr/share/doc/ziplock/CHANGELOG.md"
          }
          EOF

          # Create install script for AUR
          cat > ziplock.install << 'EOF'
          post_install() {
              update-desktop-database -q
              gtk-update-icon-cache -q /usr/share/icons/hicolor
          }

          post_upgrade() {
              post_install
          }

          post_remove() {
              update-desktop-database -q
              gtk-update-icon-cache -q /usr/share/icons/hicolor
          }
          EOF

          # Create source archive for AUR
          tar -czf "ziplock-${VERSION}.tar.gz" ziplock-src/

          # Change ownership to builder user and build
          chown -R builder:builder .

          # Generate .SRCINFO for AUR
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

          # Copy results back to workspace
          cp PKGBUILD .SRCINFO ziplock.install ziplock-*.tar.gz "$GITHUB_WORKSPACE/target/arch-package/" || true
          mkdir -p "$GITHUB_WORKSPACE/target/arch-package"
          cp PKGBUILD .SRCINFO ziplock.install ziplock-*.tar.gz "$GITHUB_WORKSPACE/target/arch-package/"

      - name: Upload Arch package
        uses: actions/upload-artifact@v4
        with:
          name: arch-package
          path: target/arch-package/
          retention-days: 30

  # Performance benchmarks (only on main branch)
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-22.04
    needs: [test-and-build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Linux binaries
        uses: actions/download-artifact@v4
        with:
          name: linux-binaries
          path: target/artifacts/linux/

      - name: Run benchmarks
        run: |
          # Make binaries executable
          chmod +x target/artifacts/linux/binaries/*

          # Install virtual display for GUI testing
          sudo apt-get update
          sudo apt-get install -y xvfb

          # Run basic performance tests
          echo "# ZipLock Performance Benchmarks" > benchmark-results.md
          echo "Generated: $(date -u)" >> benchmark-results.md
          echo "Commit: ${{ github.sha }}" >> benchmark-results.md
          echo "" >> benchmark-results.md

          # Test basic functionality with virtual display for GUI app
          echo "## Version Information" >> benchmark-results.md
          echo '```' >> benchmark-results.md

          # GUI version with virtual display
          xvfb-run -a ./target/artifacts/linux/binaries/ziplock --version >> benchmark-results.md 2>&1 || echo "ziplock version failed" >> benchmark-results.md

          echo '```' >> benchmark-results.md
          echo "" >> benchmark-results.md

          # Basic functionality test
          echo "## Basic Functionality Test" >> benchmark-results.md
          echo '```' >> benchmark-results.md
          xvfb-run -a ./target/artifacts/linux/binaries/ziplock --help | head -10 >> benchmark-results.md 2>&1 || echo "Help command failed" >> benchmark-results.md
          echo '```' >> benchmark-results.md

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.md
          retention-days: 30

  # Create unified release (only on tags)
  release:
    name: Create Unified Release
    runs-on: ubuntu-22.04
    needs:
      [
        test-and-build,
        build-android,
        package-debian,
        package-arch,
        security-audit,
      ]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts/

      - name: Create unified release structure
        run: |
          VERSION="${{ needs.test-and-build.outputs.version }}"
          RELEASE_DIR="unified-release"

          # Create release directory structure
          mkdir -p "$RELEASE_DIR"/{linux/{binaries,packages},android/{libraries,headers},docs}

          # Copy Linux binaries
          if [ -d "artifacts/linux-binaries" ]; then
            cp -r artifacts/linux-binaries/* "$RELEASE_DIR/linux/"
          fi

          # Copy Linux packages
          if [ -d "artifacts/debian-package" ]; then
            cp artifacts/debian-package/*.deb "$RELEASE_DIR/linux/packages/" 2>/dev/null || true
          fi

          if [ -d "artifacts/arch-package" ]; then
            mkdir -p "$RELEASE_DIR/linux/packages/arch"
            cp artifacts/arch-package/* "$RELEASE_DIR/linux/packages/arch/" 2>/dev/null || true
          fi

          # Copy Android libraries
          if [ -d "artifacts/android-libraries" ]; then
            cp -r artifacts/android-libraries/* "$RELEASE_DIR/android/libraries/"

            # Copy headers if they exist
            if [ -f "artifacts/android-libraries/ziplock.h" ]; then
              cp artifacts/android-libraries/ziplock.h "$RELEASE_DIR/android/headers/"
            fi
          fi

          # Copy documentation
          cp README.md "$RELEASE_DIR/docs/"
          cp CHANGELOG.md "$RELEASE_DIR/docs/" 2>/dev/null || true
          cp -r docs/ "$RELEASE_DIR/docs/technical/" 2>/dev/null || true

          # Create release info
          cat > "$RELEASE_DIR/release-info.json" << EOF
          {
            "version": "$VERSION",
            "build_date": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "platforms": {
              "linux": {
                "architectures": ["x86_64"],
                "formats": ["deb", "arch"]
              },
              "android": {
                "architectures": ["arm64-v8a", "armeabi-v7a"],
                "api_level": 21
              }
            }
          }
          EOF

          # Create README for the release
          cat > "$RELEASE_DIR/README.md" << EOF
          # ZipLock v$VERSION - Unified Release

          This is a unified release containing both Linux and Android builds of ZipLock.

          ## Contents

          ### Linux (x86_64)
          - \`linux/binaries/\` - Compiled binaries for Linux
          - \`linux/packages/ziplock_${VERSION}_amd64.deb\` - Debian/Ubuntu package
          - \`linux/packages/arch/\` - Arch Linux package files (PKGBUILD, etc.)

          ### Android
          - \`android/libraries/\` - Native libraries for Android
            - \`arm64-v8a/\` - ARM64 libraries (modern devices)
            - \`armeabi-v7a/\` - ARMv7 libraries (older devices)
          - \`android/headers/\` - C header files for integration

          ### Documentation
          - \`docs/\` - Complete project documentation

          ## Installation

          ### Linux
          - **Debian/Ubuntu**: \`sudo dpkg -i linux/packages/ziplock_${VERSION}_amd64.deb\`
          - **Arch Linux**: Use the PKGBUILD in \`linux/packages/arch/\`
          - **Manual**: Copy binaries from \`linux/binaries/\` to your PATH

          ### Android
          See the technical documentation in \`docs/technical/android.md\` for integration instructions.

          ## Build Information
          - **Version**: $VERSION
          - **Build Date**: $(date -u)
          - **Commit**: ${{ github.sha }}
          EOF

          # Create compressed archive
          tar -czf "ziplock-v${VERSION}-unified-release.tar.gz" "$RELEASE_DIR"

      - name: Extract changelog for version
        id: changelog
        run: |
          VERSION="${{ needs.test-and-build.outputs.version }}"
          if [ -f CHANGELOG.md ]; then
            # Extract changelog section for this version
            sed -n "/## \[${VERSION}\]/,/## \[/p" CHANGELOG.md | sed '$d' > version_changelog.md
            echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
            cat version_changelog.md >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG=No changelog available for this release." >> $GITHUB_OUTPUT
          fi

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ZipLock v${{ needs.test-and-build.outputs.version }}"
          body: |
            # ZipLock v${{ needs.test-and-build.outputs.version }} - Unified Release

            This release includes builds for both Linux and Android platforms in a single unified package.

            ## ðŸ“¦ Release Contents

            ### Linux Builds
            - **Debian/Ubuntu Package**: Ready-to-install .deb package for x86_64
            - **Arch Linux Package**: PKGBUILD and source files for Arch Linux/AUR
            - **Standalone Binaries**: Direct executables for manual installation

            ### Android Builds
            - **Native Libraries**: ARM64 and ARMv7 libraries for Android integration
            - **Headers**: C header files for FFI integration
            - **Documentation**: Complete integration guide

            ## ðŸš€ Quick Start

            **Linux (Debian/Ubuntu):**
            ```bash
            wget https://github.com/ejangi/ziplock/releases/download/v${{ needs.test-and-build.outputs.version }}/ziplock_${{ needs.test-and-build.outputs.version }}_amd64.deb
            sudo dpkg -i ziplock_${{ needs.test-and-build.outputs.version }}_amd64.deb
            ```

            **Linux (Arch):**
            Download the arch package files and use makepkg, or install from AUR.

            **Android:**
            Download the unified release archive and follow the integration guide in the documentation.

            ## ðŸ“‹ Changelog

            ${{ steps.changelog.outputs.CHANGELOG }}

            ## ðŸ”§ Technical Details

            - **Build Date**: $(date -u)
            - **Commit**: ${{ github.sha }}
            - **Platforms**: Linux (x86_64), Android (ARM64/ARMv7)
            - **Dependencies**: GTK4, libadwaita (Linux), API 21+ (Android)
          draft: false
          prerelease: ${{ contains(needs.test-and-build.outputs.version, '-') }}
          files: |
            ziplock-v${{ needs.test-and-build.outputs.version }}-unified-release.tar.gz
            artifacts/debian-package/*.deb
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
