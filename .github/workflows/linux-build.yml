name: Linux Build and Release

on:
  push:
    branches: [main, develop]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        rust: [stable, beta]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust }}
          components: rustfmt, clippy

      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Install system dependencies
        run: |
          # Update package lists
          sudo apt-get update

          # Install base development dependencies
          sudo apt-get install -y \
            build-essential \
            curl \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxft-dev \
            liblzma-dev

          # Install GTK4 and related libraries (using Ubuntu 22.04 default versions)
          sudo apt-get install -y \
            libgtk-4-dev \
            libgtk-4-1 \
            libgtk-4-common \
            libadwaita-1-dev \
            libadwaita-1-0 \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libgtk-3-dev \
            libgdk-pixbuf-2.0-dev \
            libglib2.0-dev \
            libcairo2-dev \
            libpango1.0-dev \
            gir1.2-gtk-4.0

          # Ensure pkg-config database is updated
          sudo ldconfig

          # Verify GTK4 installation
          echo "=== GTK4 Installation Verification ==="
          if pkg-config --exists gtk4; then
            echo "✓ GTK4 found via pkg-config"
            echo "GTK4 version: $(pkg-config --modversion gtk4)"
            echo "GTK4 prefix: $(pkg-config --variable=prefix gtk4)"
            echo "GTK4 cflags: $(pkg-config --cflags gtk4)"
            echo "GTK4 libs: $(pkg-config --libs gtk4)"

            # Note: Ubuntu 22.04 provides GTK4 4.6.x which should be sufficient
            GTK_VERSION=$(pkg-config --modversion gtk4)
            echo "Using GTK4 version $GTK_VERSION from Ubuntu repositories"
          else
            echo "✗ GTK4 not found via pkg-config"
            echo "Available GTK packages:"
            dpkg -l | grep -i gtk
            echo "PKG_CONFIG_PATH: $PKG_CONFIG_PATH"
            ls -la /usr/lib/x86_64-linux-gnu/pkgconfig/gtk* || true
            exit 1
          fi
          echo "==================================="

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: |
          # Run clippy on backend and shared libraries (no GUI dependencies)
          cargo clippy -p ziplock-backend --all-targets -- -D warnings -A clippy::uninlined-format-args -A unused-imports -A dead-code
          cargo clippy -p ziplock-shared --all-targets -- -D warnings -A clippy::uninlined-format-args -A unused-imports -A dead-code

          # Run clippy on frontend with only iced-gui features (avoiding GTK)
          cargo clippy -p ziplock-linux --no-default-features --features "iced-gui,wayland-support,file-dialog" --all-targets -- -D warnings -A clippy::uninlined-format-args -A unused-imports -A dead-code

      - name: Run tests
        run: |
          # Run tests on backend and shared libraries
          cargo test --verbose -p ziplock-backend
          cargo test --verbose -p ziplock-shared

          # Run tests on frontend with only iced-gui features (avoiding GTK)
          cargo test --verbose -p ziplock-linux --no-default-features --features "iced-gui,wayland-support,file-dialog"

  security-audit:
    name: Security Audit
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Run security audit
        run: cargo audit

  build-linux:
    name: Build Linux Packages
    runs-on: ubuntu-22.04
    needs: [test, security-audit]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create containerized build environment
        run: |
          # Create Dockerfile for consistent build environment
          cat > Dockerfile.build << 'EOF'
          FROM ubuntu:22.04

          # Prevent interactive prompts during package installation
          ENV DEBIAN_FRONTEND=noninteractive
          ENV TZ=UTC

          # Install system dependencies
          RUN apt-get update && apt-get install -y \
            curl \
            build-essential \
            pkg-config \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxft-dev \
            liblzma-dev \
            libgtk-4-dev \
            libadwaita-1-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libgtk-3-dev \
            libgdk-pixbuf-2.0-dev \
            dpkg-dev \
            fakeroot \
            ca-certificates \
            file \
            binutils \
            && rm -rf /var/lib/apt/lists/*

          # Install Rust
          RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y \
            --default-toolchain stable \
            --target x86_64-unknown-linux-gnu
          ENV PATH="/root/.cargo/bin:${PATH}"

          # Verify environment
          RUN echo "=== Build Container Environment ===" && \
            echo "OS Release:" && cat /etc/os-release && \
            echo "glibc version:" && ldd --version && \
            echo "Rust version:" && rustc --version && \
            echo "=================================="

          # Create cargo cache directory
          RUN mkdir -p /root/.cargo

          WORKDIR /workspace
          EOF

      - name: Build Docker image
        run: |
          docker build -f Dockerfile.build -t ziplock-builder .

      - name: Cache cargo dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-ubuntu-22.04-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-ubuntu-22.04-

      - name: Build binaries in container
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -v ~/.cargo:/root/.cargo \
            -e TARGET_ARCH=x86_64-unknown-linux-gnu \
            -e CARGO_TARGET_DIR=/workspace/target \
            -e RUSTFLAGS="-C target-cpu=x86-64" \
            ziplock-builder bash -c "
              set -euo pipefail
              chmod +x scripts/build/build-linux.sh
              chmod +x scripts/build/package-deb.sh

              # Verify Rust environment
              echo 'Container Rust environment:'
              rustc --version
              cargo --version
              echo 'Target glibc version in container:'
              ldd --version | head -1

              # Build with container environment
              ./scripts/build/build-linux.sh \
                --target x86_64-unknown-linux-gnu \
                --profile release

              # Verify built binaries
              echo 'Verifying built binaries:'
              file /workspace/target/x86_64-unknown-linux-gnu/release/ziplock-backend
              file /workspace/target/x86_64-unknown-linux-gnu/release/ziplock
              ldd /workspace/target/x86_64-unknown-linux-gnu/release/ziplock-backend | head -5
            "

      - name: Create Debian package in container
        run: |
          docker run --rm \
            -v $PWD:/workspace \
            -e PACKAGE_ARCH=amd64 \
            ziplock-builder bash -c "
              set -euo pipefail

              # Verify installation structure exists
              if [ ! -d '/workspace/target/install' ]; then
                echo 'ERROR: Installation structure not found'
                exit 1
              fi

              echo 'Creating Debian package...'
              ./scripts/build/package-deb.sh --arch amd64

              # Verify package was created
              if [ ! -f '/workspace/target/ziplock_*_amd64.deb' ]; then
                echo 'ERROR: Debian package was not created'
                exit 1
              fi

              echo 'Package created successfully:'
              ls -la /workspace/target/*.deb
            "

      - name: Test package installation
        run: |
          # Test package in clean Ubuntu 22.04 container
          echo "Testing package installation in Ubuntu 22.04..."
          docker run --rm -v $PWD:/workspace ubuntu:22.04 bash -c "
            set -euo pipefail
            cd /workspace
            export DEBIAN_FRONTEND=noninteractive

            # Update package lists
            apt-get update

            # Check glibc version in test container
            echo 'Test container glibc version:'
            ldd --version | head -1

            # Install the package (this will automatically install dependencies)
            echo 'Installing ZipLock package...'
            apt-get install -y ./target/ziplock_*_amd64.deb

            # Verify installation
            echo 'Verifying installation...'
            dpkg -l | grep ziplock

            # Test binaries exist and are executable
            echo 'Testing binary existence...'
            test -x /usr/bin/ziplock-backend || (echo 'Backend binary not found or not executable' && exit 1)
            test -x /usr/bin/ziplock || (echo 'Frontend binary not found or not executable' && exit 1)

            # Check binary dependencies
            echo 'Checking binary dependencies...'
            ldd /usr/bin/ziplock-backend && echo 'Backend: dependencies resolved'
            ldd /usr/bin/ziplock && echo 'Frontend: dependencies resolved'

            # Test basic functionality (version check)
            echo 'Testing basic functionality...'
            /usr/bin/ziplock-backend --version
            echo 'Backend version check: OK'

            # Test frontend version (in non-GUI mode)
            /usr/bin/ziplock --version || echo 'Frontend version check: OK (may require display)'

            echo 'Package installation test completed successfully!'
          " || {
            echo "Package installation test failed!"
            echo "Checking package contents for debugging:"
            docker run --rm -v $PWD:/workspace ubuntu:22.04 bash -c "
              cd /workspace
              apt-get update > /dev/null 2>&1
              dpkg --info ./target/ziplock_*_amd64.deb
              echo 'Package file listing:'
              dpkg --contents ./target/ziplock_*_amd64.deb | head -20
            "
            exit 1
          }

      - name: Analyze binary dependencies
        run: |
          echo "=== Binary Dependency Analysis ==="
          echo "Build environment glibc version:"
          docker run --rm ziplock-builder ldd --version | head -1
          echo ""
          echo "Backend binary glibc requirements:"
          objdump -T target/x86_64-unknown-linux-gnu/release/ziplock-backend | grep GLIBC | sort -V | tail -5 || echo "No GLIBC symbols found"
          echo ""
          echo "Frontend binary glibc requirements:"
          objdump -T target/x86_64-unknown-linux-gnu/release/ziplock | grep GLIBC | sort -V | tail -5 || echo "No GLIBC symbols found"
          echo ""
          echo "Maximum glibc version required:"
          echo "Backend:"
          readelf -V target/x86_64-unknown-linux-gnu/release/ziplock-backend | grep GLIBC | sort -V | tail -1 || echo "No version info"
          echo "Frontend:"
          readelf -V target/x86_64-unknown-linux-gnu/release/ziplock | grep GLIBC | sort -V | tail -1 || echo "No version info"
          echo "================================="

      - name: Comprehensive package validation
        run: |
          echo "=== Comprehensive Package Validation ==="

          # Check package file exists and has reasonable size
          PACKAGE_FILE=$(ls target/ziplock_*_amd64.deb | head -1)
          if [ ! -f "$PACKAGE_FILE" ]; then
            echo "ERROR: Package file not found"
            exit 1
          fi

          PACKAGE_SIZE=$(stat -c%s "$PACKAGE_FILE")
          echo "Package size: $PACKAGE_SIZE bytes"
          if [ "$PACKAGE_SIZE" -lt 1000000 ]; then  # Less than 1MB
            echo "WARNING: Package seems too small"
          fi

          # Validate package structure
          echo "Validating package structure..."
          dpkg-deb --contents "$PACKAGE_FILE" | grep -q "usr/bin/ziplock-backend" || {
            echo "ERROR: Backend binary not found in package"
            exit 1
          }
          dpkg-deb --contents "$PACKAGE_FILE" | grep -q "usr/bin/ziplock" || {
            echo "ERROR: Frontend binary not found in package"
            exit 1
          }
          dpkg-deb --contents "$PACKAGE_FILE" | grep -q "lib/systemd/system/ziplock-backend.service" || {
            echo "ERROR: Systemd service file not found in package"
            exit 1
          }

          # Check package metadata
          echo "Package control information:"
          dpkg-deb --info "$PACKAGE_FILE" | grep -E "(Package|Version|Architecture|Depends)"

          # Verify binary architecture
          echo "Verifying binary architecture..."
          docker run --rm -v $PWD:/workspace ubuntu:22.04 bash -c "
            cd /workspace
            dpkg --add-architecture amd64
            dpkg-deb --extract ./target/ziplock_*_amd64.deb /tmp/extract
            file /tmp/extract/usr/bin/ziplock-backend | grep -q 'x86-64' || {
              echo 'ERROR: Backend binary is not x86-64'
              exit 1
            }
            file /tmp/extract/usr/bin/ziplock | grep -q 'x86-64' || {
              echo 'ERROR: Frontend binary is not x86-64'
              exit 1
            }
            echo 'Binary architecture validation: PASSED'
          "

          echo "Package validation completed successfully!"

      - name: Generate build report
        run: |
          echo "=== ZipLock Build Report ===" > build-report.txt
          echo "Build Date: $(date)" >> build-report.txt
          echo "Commit: ${{ github.sha }}" >> build-report.txt
          echo "Branch: ${{ github.ref_name }}" >> build-report.txt
          echo "" >> build-report.txt

          echo "=== Build Environment ===" >> build-report.txt
          docker run --rm ziplock-builder bash -c "
            echo 'OS: $(cat /etc/os-release | grep PRETTY_NAME | cut -d= -f2 | tr -d \")'
            echo 'glibc: $(ldd --version | head -1)'
            echo 'Rust: $(rustc --version)'
            echo 'GCC: $(gcc --version | head -1)'
          " >> build-report.txt
          echo "" >> build-report.txt

          echo "=== Package Information ===" >> build-report.txt
          PACKAGE_FILE=$(ls target/ziplock_*_amd64.deb | head -1)
          echo "File: $(basename $PACKAGE_FILE)" >> build-report.txt
          echo "Size: $(du -h $PACKAGE_FILE | cut -f1)" >> build-report.txt
          dpkg-deb --info "$PACKAGE_FILE" | grep -E "(Package|Version|Architecture|Depends|Description)" >> build-report.txt
          echo "" >> build-report.txt

          echo "=== Binary Analysis ===" >> build-report.txt
          echo "Backend binary size: $(du -h target/x86_64-unknown-linux-gnu/release/ziplock-backend | cut -f1)" >> build-report.txt
          echo "Frontend binary size: $(du -h target/x86_64-unknown-linux-gnu/release/ziplock | cut -f1)" >> build-report.txt
          echo "Max glibc version required:" >> build-report.txt
          objdump -T target/x86_64-unknown-linux-gnu/release/ziplock-backend | grep GLIBC | sort -V | tail -1 >> build-report.txt
          echo "" >> build-report.txt

          echo "=== Test Results ===" >> build-report.txt
          echo "Package installation: PASSED" >> build-report.txt
          echo "Binary dependencies: RESOLVED" >> build-report.txt
          echo "Architecture validation: PASSED" >> build-report.txt
          echo "=========================" >> build-report.txt

          echo "Build report generated:"
          cat build-report.txt

      - name: Upload build report
        uses: actions/upload-artifact@v4
        with:
          name: build-report
          path: build-report.txt
          retention-days: 30

      - name: Cleanup build artifacts
        run: |
          # Remove temporary build files
          rm -f Dockerfile.build
          docker rmi ziplock-builder || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ziplock-linux-amd64
          path: |
            target/ziplock_*_amd64.deb
            target/x86_64-unknown-linux-gnu/release/ziplock-backend
            target/x86_64-unknown-linux-gnu/release/ziplock
          retention-days: 30

  release:
    name: Create Release
    runs-on: ubuntu-22.04
    needs: [build-linux]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Prepare release assets
        run: |
          mkdir -p release-assets

          # Copy .deb packages
          find artifacts -name "*.deb" -exec cp {} release-assets/ \;

          # Create checksums
          cd release-assets
          sha256sum *.deb > SHA256SUMS

          # List files for verification
          ls -la

      - name: Extract version from tag
        id: version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Extract changelog for version
        id: changelog
        run: |
          # Extract the version section from CHANGELOG.md
          VERSION="${{ steps.version.outputs.VERSION }}"

          # First try to find a specific version entry [x.y.z]
          CHANGELOG_SECTION=""
          if grep -q "## \[$VERSION\]" CHANGELOG.md; then
            # Extract from version header to next version header or end of file
            CHANGELOG_SECTION=$(awk "/^## \[$VERSION\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          elif grep -q "## \[Unreleased\]" CHANGELOG.md; then
            # If no specific version found, use Unreleased section
            CHANGELOG_SECTION=$(awk "/^## \[Unreleased\]/{flag=1; next} /^## \[/{flag=0} flag" CHANGELOG.md)
          fi

          # Clean up and format the changelog section
          if [ -n "$CHANGELOG_SECTION" ]; then
            # Remove empty lines at the beginning and end, format for release notes
            CHANGELOG_SECTION=$(echo "$CHANGELOG_SECTION" | sed '/^$/d' | sed 's/^### /## /')
            echo "CHANGELOG_CONTENT<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG_SECTION" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            echo "CHANGELOG_CONTENT=No changelog entries found for this version." >> $GITHUB_OUTPUT
          fi

      - name: Create release notes
        run: |
          cat > release-notes.md << EOF
          # ZipLock v${{ steps.version.outputs.VERSION }}

          ## 🚀 What's New

          ${{ steps.changelog.outputs.CHANGELOG_CONTENT }}

          ## 📦 Installation

          ### Ubuntu/Debian
          \`\`\`bash
          wget https://github.com/ejangi/ziplock/releases/download/v${{ steps.version.outputs.VERSION }}/ziplock_${{ steps.version.outputs.VERSION }}_amd64.deb
          sudo dpkg -i ziplock_${{ steps.version.outputs.VERSION }}_amd64.deb
          sudo apt-get install -f  # Fix any dependency issues
          \`\`\`

          ## 🔧 Usage

          After installation:
          1. Launch ZipLock from your applications menu or run \`ziplock\` in terminal
          2. The backend service will start automatically and run on boot
          3. Create your first password vault or import from another password manager

          ## 🛡️ Security

          - All sensitive operations handled by secure backend service
          - Master key never leaves your device
          - Zero-knowledge architecture
          - Automatic security audits via GitHub Actions

          ## 📋 System Requirements

          - Ubuntu 20.04+ or Debian 11+
          - X11 or Wayland display server
          - 50MB disk space
          - systemd (for backend service)

          ## 📝 Full Changelog

          See [CHANGELOG.md](https://github.com/ejangi/ziplock/blob/v${{ steps.version.outputs.VERSION }}/CHANGELOG.md) for detailed changes.
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: "ZipLock v${{ steps.version.outputs.VERSION }}"
          body_path: release-notes.md
          draft: false
          prerelease: ${{ contains(steps.version.outputs.VERSION, '-') }}
          files: |
            release-assets/*.deb
            release-assets/SHA256SUMS
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload to package repositories
        if: "!contains(steps.version.outputs.VERSION, '-')"
        run: |
          echo "🚀 Release v${{ steps.version.outputs.VERSION }} created successfully!"
          echo "📦 .deb packages are available for download"
          echo "🔄 Consider setting up automatic package repository deployment"

  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-22.04
    needs: [test]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libfontconfig1-dev \
            libfreetype6-dev \
            libx11-dev \
            libxft-dev \
            liblzma-dev \
            pkg-config \
            libgtk-4-dev \
            libadwaita-1-dev \
            libatk1.0-dev \
            libatk-bridge2.0-dev \
            libgtk-3-dev \
            libgdk-pixbuf-2.0-dev

      - name: Run benchmarks
        run: |
          # Run any performance benchmarks
          cargo bench --workspace || true

          # Measure binary sizes
          cargo build --release
          echo "## Binary Sizes" >> benchmark-results.md
          echo "| Binary | Size |" >> benchmark-results.md
          echo "|--------|------|" >> benchmark-results.md
          echo "| ziplock-backend | $(du -h target/release/ziplock-backend | cut -f1) |" >> benchmark-results.md
          echo "| ziplock | $(du -h target/release/ziplock | cut -f1) |" >> benchmark-results.md

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark-results.md
          retention-days: 30
