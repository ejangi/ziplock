<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs"
     xmlns:ui="http://wixtoolset.org/schemas/v4/wxs/ui">
  <Package Name="ZipLock Password Manager"
           Language="1033"
           Version="!(bind.FileVersion.ZipLockExe)"
           Manufacturer="ZipLock Project"
           UpgradeCode="12345678-1234-1234-1234-123456789012"
           InstallerVersion="500"
           Compressed="yes"
           Scope="perMachine">

    <!-- Package description -->
    <SummaryInformation Description="ZipLock Password Manager - Secure password management using encrypted 7z archives" />

    <!-- Allow upgrades and prevent downgrades -->
    <MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

    <!-- Embed the CAB file in the MSI -->
    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <!-- Feature definitions -->
    <Feature Id="ProductFeature" Title="ZipLock Password Manager" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
      <ComponentRef Id="ApplicationShortcut" />
      <ComponentRef Id="DesktopShortcut" />
      <ComponentRef Id="FileAssociations" />
      <ComponentRef Id="AppDataDirectory" />
      <ComponentRef Id="VCRedist" />
    </Feature>

    <!-- Installation directory structure -->
    <StandardDirectory Id="ProgramFiles64Folder">
      <Directory Id="INSTALLFOLDER" Name="ZipLock">
        <Directory Id="BINDIR" Name="bin" />
      </Directory>
    </StandardDirectory>

    <!-- Start Menu -->
    <StandardDirectory Id="ProgramMenuFolder">
      <Directory Id="ApplicationProgramsFolder" Name="ZipLock" />
    </StandardDirectory>

    <!-- Desktop -->
    <StandardDirectory Id="DesktopFolder" />

    <!-- Application Data -->
    <StandardDirectory Id="CommonAppDataFolder">
      <Directory Id="APPDATAFOLDER" Name="ZipLock">
        <Directory Id="LOGSFOLDER" Name="logs" />
      </Directory>
    </StandardDirectory>

    <!-- Components -->
    <ComponentGroup Id="ProductComponents" Directory="BINDIR">
      <!-- Main executable -->
      <Component Id="ZipLockExecutable">
        <File Id="ZipLockExe"
              Source="$(var.SourceDir)\ziplock.exe"
              Checksum="yes" />

        <!-- Application registry entries -->
        <RegistryKey Root="HKLM" Key="SOFTWARE\ZipLock">
          <RegistryValue Name="InstallPath" Value="[INSTALLFOLDER]" Type="string" />
          <RegistryValue Name="Version" Value="[ProductVersion]" Type="string" />
          <RegistryValue Name="LogPath" Value="[CommonAppDataFolder]ZipLock\logs" Type="string" />
        </RegistryKey>
      </Component>

      <!-- Microsoft Visual C++ Redistributable -->
      <Component Id="VCRedist" Condition="NOT VCREDIST_INSTALLED">
        <File Id="VCRedistExe"
              Source="$(var.SourceDir)\vc_redist.x64.exe"
              Checksum="yes" />
      </Component>

      <!-- File associations for .7z files -->
      <Component Id="FileAssociations">
        <RegistryKey Root="HKCR" Key=".7z\OpenWithProgids">
          <RegistryValue Name="ZipLock.Archive" Value="" Type="string" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key="ZipLock.Archive">
          <RegistryValue Value="ZipLock Password Archive" Type="string" />
          <RegistryValue Name="DefaultIcon" Value="[INSTALLFOLDER]bin\ziplock.exe,0" Type="string" />
        </RegistryKey>
        <RegistryKey Root="HKCR" Key="ZipLock.Archive\shell\open\command">
          <RegistryValue Value="&quot;[#ZipLockExe]&quot; &quot;%1&quot;" Type="string" />
        </RegistryKey>
      </Component>

      <!-- Application data directory -->
      <Component Id="AppDataDirectory">
        <CreateFolder Directory="APPDATAFOLDER" />
        <CreateFolder Directory="LOGSFOLDER" />
        <RemoveFolder Id="RemoveAppDataFolder" Directory="APPDATAFOLDER" On="uninstall" />
        <RemoveFolder Id="RemoveLogsFolder" Directory="LOGSFOLDER" On="uninstall" />
        <RegistryValue Root="HKCU" Key="Software\ZipLock" Name="AppDataCreated" Type="integer" Value="1" />
      </Component>
    </ComponentGroup>

    <!-- Application shortcuts -->
    <Component Id="ApplicationShortcut" Directory="ApplicationProgramsFolder">
      <Shortcut Id="ApplicationStartMenuShortcut"
                Name="ZipLock Password Manager"
                Target="[#ZipLockExe]"
                WorkingDirectory="BINDIR"
                Icon="ZipLockIcon.ico"
                Description="Secure password management using encrypted archives" />
      <RemoveFolder Id="CleanUpShortCut" Directory="ApplicationProgramsFolder" On="uninstall" />
      <RegistryValue Root="HKCU" Key="Software\ZipLock" Name="installed" Type="integer" Value="1" />
    </Component>

    <!-- Desktop shortcut (optional) -->
    <Component Id="DesktopShortcut" Directory="DesktopFolder">
      <Shortcut Id="DesktopApplicationShortcut"
                Name="ZipLock Password Manager"
                Target="[#ZipLockExe]"
                WorkingDirectory="BINDIR"
                Icon="ZipLockIcon.ico"
                Description="Secure password management using encrypted archives" />
      <RegistryValue Root="HKCU" Key="Software\ZipLock" Name="desktop_shortcut" Type="integer" Value="1" />
    </Component>

    <!-- Icon definitions -->
    <Icon Id="ZipLockIcon.ico" SourceFile="$(var.SourceDir)\..\packaging\windows\resources\ziplock.ico" />
    <Icon Id="ZipLockSmallIcon.ico" SourceFile="$(var.SourceDir)\..\packaging\windows\resources\ziplock-small.ico" />

    <!-- Properties for Add/Remove Programs -->
    <Property Id="ARPPRODUCTICON" Value="ZipLockIcon.ico" />
    <Property Id="ARPHELPLINK" Value="https://github.com/ejangi/ziplock" />
    <Property Id="ARPURLINFOABOUT" Value="https://github.com/ejangi/ziplock" />
    <Property Id="ARPNOREPAIR" Value="1" />
    <Property Id="ARPNOMODIFY" Value="1" />

    <!-- Custom properties -->
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />

    <!-- Check for VC++ Redistributable -->
    <Property Id="VCREDIST_INSTALLED">
      <RegistrySearch Id="VCRedistRegistry"
                      Root="HKLM"
                      Key="SOFTWARE\Microsoft\VisualStudio\14.0\VC\Runtimes\x64"
                      Name="Installed"
                      Type="raw" />
    </Property>

    <!-- UI configuration -->
    <ui:WixUI Id="WixUI_InstallDir" />

    <!-- License agreement -->
    <WixVariable Id="WixUILicenseRtf" Value="license.rtf" />

    <!-- Custom Actions -->
    <CustomAction Id="InstallVCRedist"
                  FileRef="VCRedistExe"
                  ExeCommand="/quiet /norestart"
                  Execute="deferred"
                  Return="check"
                  Impersonate="no" />

    <!-- Installation sequence -->
    <InstallExecuteSequence>
      <Custom Action="InstallVCRedist" After="InstallFiles" Condition="NOT VCREDIST_INSTALLED AND NOT REMOVE" />
    </InstallExecuteSequence>

  </Package>
</Wix>
