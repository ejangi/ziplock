# Maintainer: James Angus <james@ejangi.com>
pkgname=ziplock
pkgver=0.2.5
pkgrel=1
pkgdesc="A secure, portable password manager using encrypted 7z archives"
arch=('x86_64')
url="https://github.com/ejangi/ziplock"
license=('Apache')
depends=('glibc' 'fontconfig' 'freetype2' 'libx11' 'libxft' 'xz' 'gcc-libs' 'shared-mime-info')
optdepends=('gnome-keyring: for GNOME keyring integration'
           'kwallet: for KDE wallet integration'
           'firejail: for additional sandboxing'
           'desktop-file-utils: for desktop database updates')
makedepends=('rust' 'cargo' 'pkg-config')
provides=('ziplock')
conflicts=('ziplock-bin' 'ziplock-git')
backup=('etc/ziplock/config.yml')
install=ziplock.install
source=("$pkgname-$pkgver.tar.gz::https://github.com/ejangi/ziplock/archive/v$pkgver.tar.gz")
sha256sums=('d9bb7b5131ca089c04ae712df94fb2972995943b711e5a22c0e6124694950448')

prepare() {
    cd "$pkgname-$pkgver"

    # Update Cargo.lock to ensure reproducible builds
    cargo fetch --locked --target "$CARCH-unknown-linux-gnu"
}

build() {
    cd "$pkgname-$pkgver"

    # Set build environment
    export RUSTUP_TOOLCHAIN=stable
    export CARGO_TARGET_DIR=target
    export RUSTFLAGS="-C opt-level=3 -C target-cpu=native"

    # Build the workspace with release profile
    cargo build --release --locked --workspace
}

check() {
    cd "$pkgname-$pkgver"

    # Run tests
    cargo test --release --locked --workspace
}

package() {
    cd "$pkgname-$pkgver"

    # Install binaries
    install -Dm755 target/release/ziplock "$pkgdir/usr/bin/ziplock"

    # Install shared library
    install -Dm755 target/release/libziplock_shared.so "$pkgdir/usr/lib/libziplock_shared.so"

    # Install configuration
    install -Dm644 config/config.yml "$pkgdir/etc/ziplock/config.yml"

    # Install desktop file if it exists
    if [ -f apps/linux/resources/ziplock.desktop ]; then
        install -Dm644 apps/linux/resources/ziplock.desktop "$pkgdir/usr/share/applications/ziplock.desktop"
    fi

    # Install MIME type definition for .7z file associations
    if [ -f apps/linux/resources/mime/packages/ziplock.xml ]; then
        install -Dm644 apps/linux/resources/mime/packages/ziplock.xml "$pkgdir/usr/share/mime/packages/ziplock.xml"
    fi

    # Install icon
    if [ -f apps/linux/resources/icons/ziplock.svg ]; then
        install -Dm644 apps/linux/resources/icons/ziplock.svg "$pkgdir/usr/share/icons/hicolor/scalable/apps/ziplock.svg"
    elif [ -f assets/icons/ziplock-logo.svg ]; then
        install -Dm644 assets/icons/ziplock-logo.svg "$pkgdir/usr/share/icons/hicolor/scalable/apps/ziplock.svg"
    fi

    # Install license
    install -Dm644 LICENSE.md "$pkgdir/usr/share/licenses/$pkgname/LICENSE"

    # Install documentation
    install -Dm644 README.md "$pkgdir/usr/share/doc/$pkgname/README.md"
    install -Dm644 CHANGELOG.md "$pkgdir/usr/share/doc/$pkgname/CHANGELOG.md"


}
